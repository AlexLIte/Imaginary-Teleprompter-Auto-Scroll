<!DOCTYPE html>
<!--
	Teleprompter
	Copyright (C) 2015 Imaginary Films LLC and contributors

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>

<head>
    <meta content="text/html; charset=windows-1252" http-equiv="content-type">
    <title>Output | Teleprompter by Imaginary Films</title>
    <link href="favicon.ico" rel="icon" type="image/x-icon" />
    <script src="js/jquery.min.js"></script>
    <script src="js/pep.min.js"></script>
    <script src="js/jquery.popupwindow.js"></script>
    <link rel="stylesheet" href="ckeditor/contents.css">
    <link rel="stylesheet" href="css/prompterstyle.css">
</head>

<body>
    <div id="pointerArea" touch-action="none"></div>
    <table border="0" cellpadding="0" cellspacing="0" id="overlay" class="cke_editable">
        <tbody>
            <tr id="overlayTop" class="overlayBg">
                <td> </td>
            </tr>
            <tr id="overlayFocus">
                <td>
                    <div id="arrow"></div>
                </td>
            </tr>
            <tr id="overlayBottom" class="overlayBg">
                <td> </td>
            </tr>
        </tbody>
    </table>
    <div id="scroll_wrapper">
        <div id="text_block" class="cke_editable"></div>
    </div>
    <script>
        (function() {
         
         
        
            //Encapsulate the code in an anonymous function to not fill the global object. (Window)
            //JavaSript Strict
            "use strict";
            var play = false;
            var flipH = 0;
            var flipV = 0;
            var focus = 0;
            // Object identifiers
            var wrapper = $('#scroll_wrapper');
            var prompt = $('#text_block');
            var currPadding = wrapper.height();
            // Set speed controls
            var unit = 1 //wrapper.height();
            if (unit<1)
                unit=0;
            var speed = unit; // initial speed
            var sensitivity = 1.2;
            var limit = 50/sensitivity;
            var negLimit = limit*-1;
            // Parse values from localStorage
            var obj = JSON.parse(localStorage.getItem('data'));
            prompt.html(decodeURIComponent(obj.html));
            var timeoutStat;

            function atStart() {
                return (wrapper.scrollTop()===0);
            }

            function atEnd() {
                return (wrapper.scrollTop()===wrapper.height()+prompt.height());
            }
            
            function negSpeed() {
                if (speed>negLimit&&!atStart()) speed -= unit;
            }

            function posSpeed() {
                if (speed<limit&&!atEnd()) speed += unit;
            }
            /*
            function recoverSpeed() {
                speed=1; // dev: get actual speed
            }
            function setPrimaryHeight(pad) {
                
            }

            function setSecondaryHeight(pad) {
                
            }

            function setSmallestHeight(pad) {
                if (secondaryPadding<primaryPadding)

            }
            */
            $( window ).resize(function() {
                currHeight=wrapper.height();
                /*
                if (inIframe) 
                    setPrimaryHeight(currHeight);
                else
                    setSecondaryHeight(currHeight);
                */
            });

            function startPlay() {
                play=true;
                doScroll();
            }
            
            function stopPlay() {
                if ( !(atStart()||atEnd()) )
                {
                    play=false;
                    // Not a good practice but as of 2015 we can't implement workers for all platforms due to security limitations. Calling wrapper.stop() twice prevents multithreading bug since animate() can be preempted.
                    wrapper.stop();
                    wrapper.stop();
                }
            }

            function togglePlay() {
                if (play) 
                    stopPlay();
                else
                    startPlay();
            }

            function inIframe() {
                try {
                    return window.self !== window.top;
                } catch (e) {
                    return true;
                }
            }

            function moveToAnchor( h )
            {
                // If anchor exists...
                if ($("#"+h).length>0)
                {
                    // Pause animation
                    togglePlay();
                    // Save the URL without hash.
                    var url = location.href;
                    // Go to the target element.
                    location.href = '#'+h;
                    // If not in an iframe...
                    if (!inIframe())
                        // Change url back
                        history.replaceState(null,null,url);
                    // Scroll To Focus,
                    switch (focus) {
                        case 0:
                            // If center and flip. Take a little above center
                            if (flipV)
                            {
                                //console.log($('#overlayFocus').height());
                                wrapper.scrollTop(wrapper.scrollTop()-wrapper.height()/2+$('#overlayFocus').height()/2);
                            }
                            // If no flip. Leave a little bellow center
                            else
                                wrapper.scrollTop(wrapper.scrollTop()-wrapper.height()/2);
                            break;
                        // If top and flipped, take a bit above bottom
                        case 1:
                            if (flipV)
                                wrapper.scrollTop(wrapper.scrollTop()-wrapper.height()+$('#overlayFocus').height());
                            else
                                wrapper.scrollTop(wrapper.scrollTop()-$('#overlayFocus').height()/2);
                            break;
                        // If bottom and flipped, default position is correct
                        case 2:
                            if (!flipV)
                                wrapper.scrollTop(wrapper.scrollTop()-wrapper.height()+$('#overlayFocus').height()/2);
                            break;
                    }
                    // Resume animation
                    togglePlay();
                }
            }
            // Reset speed to 0 when reaching Top or Bottom.
            wrapper.scroll(function() {
                var currPos = wrapper.scrollTop();
                if (currPos===0 || currPos===prompt.height()+wrapper.height())
                    speed=0;
            });

            function timeout(event) {
                // Stop animation here.
                stopPlay();
                // If waiting, clear and reset.
                if (timeoutStat) {
                    window.clearTimeout(timeoutStat);
                }
                // Set: Wait one second before resuming animation
                timeoutStat = window.setTimeout( function(){
                    // If user hasn't resumed animation, resume it.
                    if (!play)
                        togglePlay();
                }, 1000);
            }
            // Bind wheel to timeout
            $(window).bind('wheel', timeout);
            //dev: Prevent wheel's default action
            //dev: Instead, increment or decrement speed values!
            
            // Stop animation while pressing on the screen, resume on letting go.
            $("#text_block").on("pointerdown", function(event) {
                stopPlay();
            });
            $("#text_block").on("pointerup", function(event) {
                startPlay();
            });

            function returnToEditor() {
            //dev: Send message to index.html and let index take care of these operations:
                if (inIframe()) {
                    $('#PromptIt', parent.document).html("<strong>Prompt It!</strong>");
                    $('#content', parent.document).css({
                        "display": "block"
                    });
                    $('#editor', parent.document).css({
                        "display": "block"
                    });
                    $('#footer', parent.document).css({
                        "display": "block"
                    });
                    $('#framecontainer', parent.document).css({
                        "display": "none"
                    });
                    document.location.href = "about:blank";
                } else window.close();
            }
         
         window.addEventListener("message", listener, false);
         function listener(event){
         if ( event.origin !== (location.protocol + '//' + location.host) ){
         console.log(event.origin);
         return;
         }
         wrapper.scrollTop(event.data);
         }

            function init() {
                // Local variables (All variables in javascript are function scope not block scope)
         
         
         
                var promptStyle = 0;
                var i = 0;
                // Get Flip values
                if (inIframe())
                    var flip = obj.data.primary;
                else
                    var flip = obj.data.secondary;
                // Flips are used to indicate both boolean action and scale values
                switch (flip) {
                    case 2:
                        flipH = -2;
                        break;
                    case 3:
                        flipV = -2;
                        break;
                    case 4:
                        flipH = -2;
                        flipV = -2;
                        break;
                }
                focus = obj.data.focusMode;
                promptStyle = obj.data.prompterStyle;

                // Flip text
                if (flipH||flipV)
                {
                    prompt.css({
                        "transform":"matrix("+(flipH+1)+",0,0,"+(flipV+1)+",0,0)",
                        "webkitTransform":"matrix("+(flipH+1)+",0,0,"+(flipV+1)+",0,0)",
                        "MozTransform":"matrix("+(flipH+1)+",0,0,"+(flipV+1)+",0,0)",
                        "msTransform":"matrix("+(flipH+1)+",0,0,"+(flipV+1)+",0,0)",
                        "OTransform":"matrix("+(flipH+1)+",0,0,"+(flipV+1)+"+,0,0)"
                    });
                }
                if (flipV) {
                    // Start scroll at inverted top
                    wrapper.scrollTop(prompt.height()+wrapper.height()-10);

                    // If focus is top or bottom, change overlay positions
                    if (focus == 1)
                        $("#overlayBottom").css("display","none");
                    else if (focus == 2)
                        $("#overlayTop").css("display","none");
                    // Reverse initial speed
                    speed *= -1;
                } else // If no vertical flip
                {
                    // If focus is top or bottom, change overlay positions.
                    if (focus == 1) $("#overlayTop").css("display","none")
                    else if (focus == 2) $("#overlayBottom").css("display","none");
                }
                // Set Teleprompter Style
                var overBgs = $('.overlayBg');
                switch (promptStyle) {
                    case 1:
                        $("body").css({
                            "background":"#FFF",
                            "color":"#000"
                        });
                        for (i = 0; i < overBgs.length; i++) overBgs[i].style.backgroundColor = '#BBB';
                        break;
                    default:
                        $("body").css({
                            "background":"#272822",
                            "color":"#FFF"
                        });
                        for (i = 0; i < overBgs.length; i++) overBgs[i].style.backgroundColor = '#000';
                }
                // Start scrolling
                //togglePlay();
            }
            //   Call init when the DOM loads
            $(document).ready(init);
        }());
    </script>
</body>

</html>
